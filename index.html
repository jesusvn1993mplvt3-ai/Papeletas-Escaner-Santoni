<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Papeletas - Cirineo</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ESTILOS GENERALES DE LA APP */
        body { background-color: #f1f5f9; height: 100vh; overflow: hidden; font-family: 'Roboto Condensed', sans-serif; }
        
        /* Ajuste para móviles: permite scroll si la pantalla es pequeña */
        @media (max-width: 768px) {
            body { height: auto; overflow: auto; }
        }

        /* Ocultar publicidad de la librería de escáner */
        #reader a { display: none !important; }
        #reader__dashboard_section_csr span { display: none !important; }

        /* ESTILOS DE LA ETIQUETA (VISUALIZACIÓN PANTALLA) */
        .label-wrapper {
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s;
            page-break-inside: avoid;
        }
        
        .label-preview-container {
            width: 6in;
            height: 4in;
            background-color: white;
            position: relative;
            box-sizing: border-box;
            border: 2px solid #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Estilos internos de la etiqueta */
        .lbl-row { display: flex; border-bottom: 2px solid #000; width: 100%; }
        .lbl-row:last-child { border-bottom: none; }
        .lbl-col { border-right: 2px solid #000; padding: 4px 8px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .lbl-col:last-child { border-right: none; }
        .lbl-title { font-size: 14px; font-weight: 700; color: #333; text-transform: uppercase; line-height: 1; margin-bottom: 2px; }
        .lbl-big { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 42px; line-height: 0.9; color: #000; white-space: nowrap; }
        .lbl-medium { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 26px; line-height: 1; color: #000; white-space: nowrap; }
        .lbl-small { font-size: 16px; font-weight: 700; color: #000; }
        
        .row-header { height: 18%; }
        .row-info { height: 12%; }
        .row-desc { height: 10%; align-items: center; }
        .row-metrics { height: 22%; }
        .row-details { height: 23%; }
        .row-footer { height: 15%; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ESTILOS CRÍTICOS DE IMPRESIÓN (6x4 EXACTO) --- */
        @media print {
            @page { 
                size: 6in 4in; 
                margin: 0mm; 
            }
            
            html, body {
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .no-print { display: none !important; }

            .print-container {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
                position: static !important;
            }

            .label-wrapper {
                display: block !important;
                width: 6in !important;
                height: 4in !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                break-after: page; 
                page-break-after: always; 
                page-break-inside: avoid;
            }

            .label-wrapper:last-child {
                break-after: auto;
                page-break-after: auto;
            }

            .label-preview-container {
                border: 2px solid #000 !important; 
                width: 6in !important;
                height: 4in !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue; 

        // --- COMPONENTE ICONO ---
        const Icon = ({ name, size = 18, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = ''; 
                    const svgString = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                    containerRef.current.innerHTML = svgString;
                }
            }, [name, size, className]);
            return <div ref={containerRef} className="inline-block" style={{ width: size, height: size }}></div>;
        };

        // --- COMPONENTE DE ETIQUETA ---
        const ProductionLabel = ({ labelData }) => {
            const svgRef = useRef(null);
            
            const order = labelData; 
            const subPiece = order.subPiecesData && order.subPiecesData.length > 0 ? order.subPiecesData[0] : {};
            
            const materialNylon = order.threading ? order.threading.find(t => t.material && t.material.toUpperCase().includes('NYLON')) : null;
            const materialLycra = order.threading ? order.threading.find(t => t.material && t.material.toUpperCase().includes('LYCRA')) : null;
            const lycraText = materialLycra ? materialLycra.material.replace(/LYCRA/i, '').trim() : (order.threading && order.threading[1] ? order.threading[1].material : 'N/A');
            const nylonText = materialNylon ? materialNylon.material.replace(/NYLON/i, '').trim() : (order.threading && order.threading[0] ? order.threading[0].material : 'N/A');
            
            const currentPackageDisplay = order.displayPackageId || '1/1';
            const piecesInPackage = order.piecesInPackage || (order.packageSize === 'VARIO' ? 'VAR' : (order.packageSize || 50));
            
            const barcodeValue = order.packageCode || `${order.codigo}-${order.partida}-1`;

            useEffect(() => {
                if (svgRef.current && barcodeValue) {
                    try {
                        JsBarcode(svgRef.current, barcodeValue, {
                            format: "CODE128",
                            lineColor: "#000",
                            width: 1.5,      
                            height: 40,      
                            displayValue: false,
                            margin: 0
                        });
                        svgRef.current.style.width = '2.5in';
                        svgRef.current.style.height = 'auto'; 
                    } catch (e) { console.error("Error barcode", e); }
                }
            }, [barcodeValue]);

            const fechaEntrega = order.fechaEntrega || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('es-MX');

            return (
                <div className="label-preview-container">
                    <div className="lbl-row row-header">
                        <div className="lbl-col" style={{width: '60%'}}>
                            <div className="lbl-title">MODELO</div>
                            <div className="lbl-big">{order.codigo || 'S/N'}</div>
                        </div>
                        <div className="lbl-col" style={{width: '40%'}}>
                            <div className="lbl-title">TOTAL PIEZAS ORDEN</div>
                            <div className="lbl-big">{order.totalPedido || 0}</div>
                        </div>
                    </div>
                    <div className="lbl-row row-info">
                        <div className="lbl-col" style={{width: '50%'}}>
                            <div className="lbl-title">PARTIDA</div>
                            <div className="lbl-medium">{order.partida || '---'}</div>
                        </div>
                        <div className="lbl-col" style={{width: '50%'}}>
                            <div className="lbl-title">CLIENTE</div>
                            <div className="lbl-medium" style={{fontSize: order.cliente?.length > 10 ? '22px' : '26px'}}>{order.cliente || '---'}</div>
                        </div>
                    </div>
                    <div className="lbl-row row-desc">
                        <div className="lbl-col" style={{flexDirection: 'row', alignItems: 'baseline', gap: '10px', width: '100%'}}>
                            <span className="lbl-title">DESCRIPCION:</span>
                            <span style={{fontSize: '16px', fontWeight: 'bold'}}>{subPiece.pieza || 'ESTANDAR'}</span>
                        </div>
                    </div>
                    <div className="lbl-row row-metrics">
                        <div className="lbl-col" style={{width: '33.33%', textAlign: 'center'}}>
                            <div className="lbl-title" style={{fontSize: '11px'}}>PAQUETE<br/>ACTUAL</div>
                            <div className="lbl-big" style={{fontSize: '48px'}}>{currentPackageDisplay}</div>
                        </div>
                        <div className="lbl-col" style={{width: '33.33%', backgroundColor: '#e0e0e0', textAlign: 'center'}}>
                            <div className="lbl-title" style={{fontSize: '11px'}}>PIEZAS EN<br/>PAQUETE</div>
                            <div className="lbl-big" style={{fontSize: '48px'}}>{piecesInPackage}</div>
                        </div>
                        <div className="lbl-col" style={{width: '33.33%', textAlign: 'center'}}>
                            <div className="lbl-title">MAQUINA</div>
                            <div className="lbl-big" style={{fontSize: '48px'}}>{order.maquina || '0'}</div>
                        </div>
                    </div>
                    <div className="lbl-row row-details">
                        <div style={{width: '50%', display: 'flex', flexDirection: 'column', borderRight: '2px solid black'}}>
                            <div style={{flex: 1, display: 'flex', alignItems: 'center', borderBottom: '1px solid black', padding: '0 5px'}}>
                                <span className="lbl-title" style={{width: '50px'}}>NYLON</span>
                                <span className="lbl-small truncate" style={{fontSize: '14px'}} title={nylonText}>{nylonText.substring(0, 18)}</span>
                            </div>
                            <div style={{flex: 1, display: 'flex', alignItems: 'center', padding: '0 5px'}}>
                                <span className="lbl-title" style={{width: '50px'}}>LYCRA</span>
                                <span className="lbl-small truncate" style={{fontSize: '14px'}} title={lycraText}>{lycraText.substring(0, 18)}</span>
                            </div>
                        </div>
                        <div style={{width: '50%', display: 'grid', gridTemplateColumns: '1fr 1fr', gridTemplateRows: '1fr 1fr'}}>
                            <div className="lbl-col" style={{borderBottom: '1px solid black', borderRight: '1px solid black', padding: '2px'}}>
                                <div className="lbl-title">TALLA</div>
                                <div className="lbl-medium" style={{fontSize: '20px'}}>{subPiece.talla || 'UNI'}</div>
                            </div>
                            <div className="lbl-col" style={{borderBottom: '1px solid black', padding: '2px'}}>
                                <div className="lbl-title">PESO (g)</div>
                                <div className="lbl-small">{subPiece.peso || '---'}</div>
                            </div>
                            <div className="lbl-col" style={{gridColumn: 'span 2', padding: '2px', flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div className="lbl-title">TIEMPO (min)</div>
                                <div className="lbl-small" style={{fontSize: '20px', marginRight: '10px'}}>{subPiece.tiempo || '---'}</div>
                            </div>
                        </div>
                    </div>
                    <div className="lbl-row row-footer" style={{padding: '0 10px', alignItems: 'center', justifyContent: 'space-between'}}>
                        <div style={{display: 'flex', flexDirection: 'column'}}>
                            <div className="lbl-title">FECHA DE ENTREGA</div>
                            <div className="lbl-medium" style={{fontSize: '20px'}}>{fechaEntrega}</div>
                        </div>
                        <div style={{display: 'flex', flexDirection: 'column', alignItems: 'flex-end', flexGrow: 1}}>
                            <svg ref={svgRef} style={{maxWidth: '2.5in', width: '2.5in', height: 'auto'}}></svg>
                            <div style={{fontSize: '10px', marginTop: '-5px'}}>{barcodeValue}</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE RASTREADOR (CON CORRECCIONES DE LAYOUT) ---
        const ScanTracker = ({ allOrders, selectedOrder, setSelectedOrder, packageLabels, onScan }) => {
            const [scannedData, setScannedData] = useState([]);
            const [scanInput, setScanInput] = useState('');
            const [scanStatus, setScanStatus] = useState({ message: 'Esperando escaneo...', type: 'info' });
            const [showCamera, setShowCamera] = useState(false);
            
            const inputRef = useRef(null);
            const scannerRef = useRef(null);
            
            const orderId = selectedOrder?.id;
            const orderCode = selectedOrder?.codigo;
            const tejedoraName = "Baitza"; 

            // Cargar datos
            useEffect(() => {
                if (!orderId) {
                    setScannedData([]);
                    setScanStatus({ message: 'Modo Escaneo Rápido: Escanee cualquier código.', type: 'info' });
                    return;
                }
                const unsubscribe = db.collection('registro_produccion')
                    .where('orderId', '==', String(orderId)) 
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => doc.data());
                        setScannedData(data);
                        setScanStatus({ message: `Orden ${orderCode} cargada.`, type: 'info' });
                    }, error => {
                        console.error(error);
                    });
                return () => unsubscribe();
            }, [orderId, orderCode]);
            
            // Focus
            useEffect(() => {
                if (inputRef.current && !showCamera) {
                    inputRef.current.focus();
                }
            }, [orderId, showCamera]);

            // CÁMARA: INICIO Y LIMPIEZA
            useEffect(() => {
                if (showCamera) {
                    // Esperar renderizado del modal
                    setTimeout(() => {
                        const html5QrcodeScanner = new Html5QrcodeScanner(
                            "reader", 
                            { 
                                fps: 10, 
                                qrbox: { width: 250, height: 150 }, // Caja de escaneo rectangular
                                aspectRatio: 1.0 
                            },
                            false
                        );
                        
                        html5QrcodeScanner.render((decodedText) => {
                            // Éxito: Procesar y Cerrar
                            console.log(`Scan result: ${decodedText}`);
                            processScannedCode(decodedText);
                            setShowCamera(false); 
                        }, (errorMessage) => {
                            // Error de lectura (normal mientras escanea)
                        });
                        
                        scannerRef.current = html5QrcodeScanner;
                    }, 100);
                } else {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(err => console.error("Error clearing scanner", err));
                        scannerRef.current = null;
                    }
                }
                
                return () => {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(err => console.error("Cleanup scanner", err));
                    }
                };
            }, [showCamera]);


            const calculatePiecesInPackage = (order, packageIndex) => {
                const totalPieces = order.totalPedido || 0;
                const packageSizeValue = order.packageSize === 'VARIO' || !order.packageSize ? 50 : (Number(order.packageSize) || 50); 
                const N = totalPieces > 0 ? Math.ceil(totalPieces / packageSizeValue) : 1; 
                if (packageIndex < N) return packageSizeValue;
                return totalPieces % packageSizeValue || packageSizeValue;
            };

            const processScannedCode = async (rawCode) => {
                if (!rawCode) return;
                
                rawCode = rawCode.trim().toUpperCase();
                let normalizedCode = rawCode.replace(/'/g, '-').replace(/\?/g, '_');
                
                const codeParts = normalizedCode.split('-');
                if (codeParts.length !== 3) {
                    setScanStatus({ message: `Error formato: ${rawCode}`, type: 'error' });
                    return;
                }
                
                const [modelCode, partidaPart, packageIndexStr] = codeParts;
                const packageIndex = Number(packageIndexStr);
                
                let orderToScan = selectedOrder;
                let isQuickScan = false;
                
                if (!selectedOrder) {
                    isQuickScan = true;
                    const foundOrder = allOrders.find(o => 
                        String(o.codigo).toUpperCase() === modelCode && 
                        String(o.partida).toUpperCase() === partidaPart
                    );
                    if (!foundOrder) {
                        setScanStatus({ message: `Código ${normalizedCode} no encontrado.`, type: 'error' });
                        return;
                    }
                    orderToScan = foundOrder;
                } 
                else if (normalizedCode !== packageLabels.find(p => p.packageCode === normalizedCode)?.packageCode) {
                    setScanStatus({ message: `Error: Código ajeno a orden actual.`, type: 'error' });
                    return;
                }

                const totalPieces = orderToScan.totalPedido || 0;
                const packageSizeValue = orderToScan.packageSize === 'VARIO' || !orderToScan.packageSize ? 50 : (Number(orderToScan.packageSize) || 50); 
                const totalPackages = totalPieces > 0 ? Math.ceil(totalPieces / packageSizeValue) : 1; 
                
                if (packageIndex > totalPackages || packageIndex < 1) {
                    setScanStatus({ message: `Paquete fuera de rango.`, type: 'error' });
                    return;
                }
                
                const piecesInThisPackage = calculatePiecesInPackage(orderToScan, packageIndex);

                const globalScanCheck = await db.collection('registro_produccion')
                                                .where('codigo_paquete', '==', normalizedCode)
                                                .get();
                if (!globalScanCheck.empty) {
                    setScanStatus({ message: `Advertencia: Paquete ${packageIndex} ya escaneado.`, type: 'warning' });
                    if (isQuickScan) setSelectedOrder(orderToScan); 
                    return;
                }

                try {
                    const docRef = db.collection('registro_produccion').doc();
                    await docRef.set({
                        codigo_paquete: normalizedCode, 
                        orderId: String(orderToScan.id), 
                        fecha: FieldValue.serverTimestamp(),
                        fecha_scan: new Date().toLocaleTimeString('es-MX') + ' p.m.', 
                        fecha_legible: new Date().toLocaleDateString('es-MX', {
                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        }).replace(/\//g, '/'), 
                        tejedor: tejedoraName,
                        tipo: "produccion",
                        modelo: orderToScan.codigo,
                        partida: orderToScan.partida,
                        paquete_indice: packageIndex,
                        paquete_total: totalPackages,
                        piezas_en_paquete: piecesInThisPackage
                    });

                    let successMessage = `OK: Pqte ${packageIndex}/${totalPackages} registrado.`;
                    if (isQuickScan) {
                        setSelectedOrder(orderToScan);
                        successMessage = `Orden cargada y Pqte ${packageIndex} registrado.`;
                    }
                    
                    setScanStatus({ message: successMessage, type: 'success' });
                    onScan();
                } catch (error) {
                    setScanStatus({ message: `Error DB: ${error.message}`, type: 'error' });
                }
            };

            const handleInputSubmit = (e) => {
                e.preventDefault();
                processScannedCode(scanInput);
                setScanInput('');
            };
            
            const { scannedPackages, pendingPackages } = useMemo(() => {
                if (!orderId) return { scannedPackages: [], pendingPackages: [] };
                const scannedCodes = new Set(scannedData.map(d => d.codigo_paquete));
                const packages = packageLabels.map(label => ({
                    ...label,
                    isScanned: scannedCodes.has(label.packageCode),
                    scanTime: scannedData.find(d => d.codigo_paquete === label.packageCode)?.fecha_legible || null, 
                }));
                return {
                    scannedPackages: packages.filter(p => p.isScanned),
                    pendingPackages: packages.filter(p => !p.isScanned)
                };
            }, [packageLabels, scannedData, orderId]);

            const statusClasses = {
                info: 'bg-blue-100 text-blue-800',
                success: 'bg-green-100 text-green-800',
                warning: 'bg-yellow-100 text-yellow-800',
                error: 'bg-red-100 text-red-800',
            };

            return (
                <div className="w-full md:w-96 bg-white border-l border-slate-200 flex flex-col no-print relative shrink-0">
                    
                    {/* MODAL CÁMARA FULLSCREEN (CORREGIDO: Fixed para que cubra toda la pantalla) */}
                    {showCamera && (
                        <div className="fixed inset-0 bg-slate-900 z-[100] flex flex-col justify-center items-center p-4">
                            <div className="w-full max-w-md bg-white rounded-lg shadow-2xl overflow-hidden">
                                <div className="flex justify-between items-center p-3 bg-slate-100 border-b">
                                    <span className="font-bold text-slate-700">Escaneando...</span>
                                    <button onClick={() => setShowCamera(false)} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs font-bold transition">CERRAR</button>
                                </div>
                                <div id="reader" className="w-full bg-black"></div>
                                <div className="p-3 text-center text-slate-500 text-sm">
                                    Apunta la cámara al código de barras.
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="p-4 border-b bg-slate-50">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Icon name="scan"/> Control</h3>
                            <button 
                                onClick={() => setShowCamera(!showCamera)}
                                className={`text-xs px-3 py-1.5 rounded flex items-center gap-1 font-bold ${showCamera ? 'bg-red-100 text-red-700' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                            >
                                <Icon name="camera" size={14} /> {showCamera ? 'CANCELAR' : 'USAR CÁMARA'}
                            </button>
                        </div>

                        <form onSubmit={handleInputSubmit} className="mt-1">
                            <input 
                                ref={inputRef}
                                type="text" 
                                value={scanInput}
                                onChange={e => setScanInput(e.target.value)}
                                placeholder={selectedOrder ? `Escanear...` : 'Modo Rápido'}
                                className="w-full border-2 border-slate-300 rounded p-2 text-sm focus:border-blue-500 focus:outline-none font-mono"
                            />
                        </form>
                        <div className={`mt-2 p-1.5 rounded text-xs text-center ${statusClasses[scanStatus.type]}`}>{scanStatus.message}</div>
                    </div>

                    {selectedOrder ? (
                        <div className="flex-grow overflow-y-auto p-3 space-y-4 max-h-96 md:max-h-full">
                            <div className="bg-red-50 p-3 rounded">
                                <h4 className="font-bold text-red-800 flex items-center gap-1 mb-2"><Icon name="clock" size={14}/> PENDIENTES ({pendingPackages.length})</h4>
                                <div className="grid grid-cols-4 gap-2">
                                    {pendingPackages.map(p => (
                                        <div key={p.packageCode} className="p-1 text-center bg-white border border-red-300 rounded text-xs font-mono">{p.packageIndex}</div>
                                    ))}
                                    {pendingPackages.length === 0 && <p className="text-xs text-red-600 col-span-4 italic">¡Completado!</p>}
                                </div>
                            </div>
                            <div className="bg-green-50 p-3 rounded">
                                <h4 className="font-bold text-green-800 flex items-center gap-1 mb-2"><Icon name="check-circle" size={14}/> LISTOS ({scannedPackages.length})</h4>
                                <div className="grid grid-cols-4 gap-2">
                                    {scannedPackages.map(p => (
                                        <div key={p.packageCode} className="p-1 text-center bg-white border border-green-300 rounded text-xs font-mono relative group">
                                            {p.packageIndex}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-grow flex items-center justify-center p-6 text-center text-slate-500 min-h-[200px]">
                            <p className="p-4 border border-dashed border-slate-300 rounded text-sm bg-slate-50">
                                Usa la pistola o la cámara para cargar una orden.
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null); 
            const [packageLabels, setPackageLabels] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [filterText, setFilterText] = useState('');
            const [scanTrackerKey, setScanTrackerKey] = useState(0); 

            const generatePackageLabels = (order) => {
                const totalPieces = order.totalPedido || 0;
                const packageSizeValue = order.packageSize === 'VARIO' || !order.packageSize ? 50 : (Number(order.packageSize) || 50); 
                const N = totalPieces > 0 ? Math.ceil(totalPieces / packageSizeValue) : 1; 

                const labels = [];
                for (let i = 1; i <= N; i++) {
                    const piecesInThisPackage = i < N ? packageSizeValue : (totalPieces % packageSizeValue || packageSizeValue);
                    const packageCode = `${order.codigo}-${order.partida}-${i}`;
                    labels.push({
                        ...order,
                        packageIndex: i, 
                        totalPackages: N, 
                        piecesInPackage: piecesInThisPackage,
                        packageCode: packageCode, 
                        displayPackageId: `${i}/${N}`, 
                    });
                }
                return labels;
            };

            const handleSuccessfulScan = useCallback(() => {
                setScanTrackerKey(prev => prev + 1); 
            }, []);

            useEffect(() => {
                const unsubscribe = db.collection('orders')
                    .where('status', '!=', 'ARCHIVADO')
                    .onSnapshot(snapshot => {
                        const fetchedOrders = snapshot.docs.map(doc => doc.data());
                        fetchedOrders.sort((a, b) => b.id - a.id);
                        setOrders(fetchedOrders);
                        setLoading(false);
                    }, error => {
                        console.error("Error fetching orders:", error);
                        setLoading(false);
                    });
                return () => unsubscribe();
            }, []);
            
            useEffect(() => {
                if (selectedOrder) {
                    setPackageLabels(generatePackageLabels(selectedOrder));
                    setScanTrackerKey(0); 
                } else {
                    setPackageLabels([]);
                }
            }, [selectedOrder]);

            const filteredOrders = useMemo(() => {
                if (!filterText) return orders;
                const txt = filterText.toUpperCase();
                return orders.filter(o => 
                    (o.codigo && o.codigo.includes(txt)) || 
                    (o.cliente && o.cliente.includes(txt)) ||
                    (o.partida && o.partida.includes(txt))
                );
            }, [orders, filterText]);

            const handlePrint = () => {
                if(packageLabels.length === 0) return;
                window.print();
            };

            const handleArchive = async () => {
                if(!selectedOrder) return;
                if(window.confirm(`¿Archivar orden ${selectedOrder.codigo}?`)) {
                    try {
                        await db.collection('orders').doc(String(selectedOrder.id)).update({
                            status: 'ARCHIVADO',
                            printDate: new Date().toISOString()
                        });
                        setSelectedOrder(null);
                    } catch (error) {
                        window.alert("Error: " + error.message);
                    }
                }
            };

            return (
                // AJUSTE CLAVE: flex-col en móvil, flex-row en escritorio (md)
                <div className="flex flex-col md:flex-row h-screen w-full">
                    
                    {/* COLUMNA 1: BARRA LATERAL */}
                    <div className="w-full md:w-96 bg-slate-800 text-white flex flex-col border-r border-slate-700 shadow-xl no-print z-10 shrink-0 h-64 md:h-auto">
                        <div className="p-4 border-b border-slate-700 bg-slate-900">
                            <h1 className="text-xl font-bold flex items-center gap-2 text-yellow-400">
                                <Icon name="printer" /> GENERADOR
                            </h1>
                            <div className="mt-4 relative">
                                <input 
                                    type="text" 
                                    placeholder="Buscar..." 
                                    value={filterText}
                                    onChange={e => setFilterText(e.target.value)}
                                    className="w-full bg-slate-800 border border-slate-600 rounded p-2 pl-8 text-sm focus:border-yellow-400 focus:outline-none"
                                />
                                <Icon name="search" size={14} className="absolute left-3 top-3 text-slate-500" />
                            </div>
                        </div>

                        <div className="flex-grow overflow-y-auto p-2 space-y-2">
                            {loading && <div className="flex justify-center p-10"><div className="loader"></div></div>}
                            {filteredOrders.map(order => (
                                <div 
                                    key={order.id}
                                    onClick={() => setSelectedOrder(order)}
                                    className={`p-3 rounded cursor-pointer border-l-4 transition-all hover:bg-slate-700 ${selectedOrder?.id === order.id ? 'bg-slate-700 border-yellow-400 shadow-md' : 'bg-slate-800/50 border-transparent hover:border-slate-500'}`}
                                >
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-lg">{order.codigo}</span>
                                        <span className="bg-slate-900 text-xs px-2 py-0.5 rounded text-slate-300 font-mono">MQ-{order.maquina}</span>
                                    </div>
                                    <div className="text-sm text-slate-300 truncate">{order.cliente}</div>
                                    <div className="flex justify-between items-end mt-2">
                                        <span className="text-xs bg-yellow-900/30 text-yellow-200 px-1 rounded">{order.partida}</span>
                                        <span className="text-xs font-bold">{order.totalPedido} pzs</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* COLUMNA 2: ÁREA PRINCIPAL */}
                    <div className="flex-grow flex-shrink min-w-0 bg-slate-100 flex flex-col relative overflow-auto h-96 md:h-auto">
                        <div className="bg-white p-4 shadow-sm border-b flex justify-between items-center no-print sticky top-0 z-10">
                            <div>
                                {selectedOrder ? (
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2 text-sm md:text-base">
                                        {selectedOrder.codigo}
                                        <span className="text-xs md:text-sm font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full whitespace-nowrap">{packageLabels.length} Etq</span>
                                    </h2>
                                ) : (
                                    <h2 className="font-bold text-slate-400">Seleccione orden</h2>
                                )}
                            </div>
                            <div className="flex gap-2">
                                {selectedOrder && (
                                    <>
                                        <button onClick={handleArchive} className="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded font-bold hover:bg-red-50 hover:text-red-600 text-xs md:text-sm">
                                            ARCHIVAR
                                        </button>
                                        <button onClick={handlePrint} className="px-3 py-2 bg-slate-900 text-white rounded font-bold hover:bg-slate-700 shadow-lg transition flex items-center gap-2 text-xs md:text-sm">
                                            <Icon name="printer" size={16}/> IMPRIMIR
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="flex-grow flex flex-col items-center p-4 md:p-10 bg-slate-200 overflow-y-auto print-container">
                            {packageLabels.length > 0 ? (
                                packageLabels.map((labelData, index) => (
                                    <div key={index} className="label-wrapper">
                                        <ProductionLabel labelData={labelData} />
                                    </div>
                                ))
                            ) : (
                                <div className="text-center text-slate-400 flex flex-col items-center mt-10 md:mt-20">
                                    <Icon name="arrow-left-circle" size={48} className="mb-4 opacity-50"/>
                                    <p className="text-lg font-bold">Selecciona una orden</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* COLUMNA 3: TRACKER (Móvil: Abajo / Desktop: Derecha) */}
                    <ScanTracker 
                        key={scanTrackerKey} 
                        allOrders={orders} 
                        selectedOrder={selectedOrder}
                        setSelectedOrder={setSelectedOrder}
                        packageLabels={packageLabels}
                        onScan={handleSuccessfulScan}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
